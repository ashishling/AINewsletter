let f={pending:[],shortlisted:[],rejected:[]},E=[],j={},A=null,p=null,D="articles",d="pending";const O=["pending","shortlisted","rejected"];let g=null;const y={pending:0,shortlisted:0,rejected:0};let x="domain_asc";async function ne(){await h(),await k()}async function h(){try{const n=await(await fetch("/api/articles")).json();f={pending:[],shortlisted:[],rejected:[]},n.articles.forEach(t=>{const s=t.status||"pending";f[s]&&f[s].push(t)}),I(),z(),await se()}catch{o("Failed to load articles","error")}}async function se(){try{const n=await(await fetch("/api/stats")).json();document.getElementById("stat-total").textContent=n.total,document.getElementById("stat-pending").textContent=n.pending,document.getElementById("stat-shortlisted").textContent=n.shortlisted,document.getElementById("stat-rejected").textContent=n.rejected}catch(e){console.error("Failed to load stats:",e)}}function oe(e){D=e,document.getElementById("tab-articles").classList.toggle("active",e==="articles"),document.getElementById("tab-subscriptions").classList.toggle("active",e==="subscriptions"),document.getElementById("articles-view").classList.toggle("active",e==="articles"),document.getElementById("subscriptions-view").classList.toggle("active",e==="subscriptions")}async function k(){const e=document.getElementById("subscriptions-list"),n=document.getElementById("subscriptions-count");try{E=(await(await fetch("/api/rss-subscriptions")).json()).subscriptions||[],n.textContent=`${E.length} subscriptions`,Q()}catch{e.innerHTML='<div class="empty-state"><p>Failed to load subscriptions</p></div>',n.textContent="Error loading subscriptions"}}function re(){const e=document.getElementById("subscriptions-sort");x=e?e.value:"domain_asc",Q()}function Q(){const e=document.getElementById("subscriptions-list");if(!E.length){e.innerHTML='<div class="empty-state"><p>No active subscriptions found.</p></div>';return}const n=[...E];x==="articles_desc"?n.sort((t,s)=>(s.article_count||0)-(t.article_count||0)):x==="articles_asc"?n.sort((t,s)=>(t.article_count||0)-(s.article_count||0)):n.sort((t,s)=>(t.domain||"").localeCompare(s.domain||"")),e.innerHTML=n.map((t,s)=>{const i=`subscription-feed-${s}`,a=t.updated_at||t.discovered_at,r=encodeURIComponent(t.domain||"");return`
                    <div class="subscription-item">
                        <div class="subscription-top">
                            <div class="subscription-domain">${m(t.domain)}</div>
                            <div class="subscription-meta">${t.article_count||0} articles in feed</div>
                        </div>
                        <div class="subscription-meta" style="margin-bottom: 8px;">
                            ${a?`Updated: ${new Date(a).toLocaleString()}`:"No update timestamp"}
                        </div>
                        <div class="subscription-edit">
                            <input id="${i}" type="url" value="${m(t.feed_url||"")}" placeholder="https://example.com/feed.xml" />
                            <div class="subscription-actions">
                                <button class="btn btn-success" onclick="saveSubscriptionByEncoded('${r}', '${i}')">Save</button>
                                <button class="btn btn-danger" onclick="removeSubscriptionByEncoded('${r}', false)">Remove Subscription</button>
                                <button class="btn btn-warning" onclick="removeSubscriptionByEncoded('${r}', true)">Remove + Delete Articles</button>
                            </div>
                        </div>
                    </div>
                `}).join("")}function U(e){try{return decodeURIComponent(e||"")}catch{return""}}function ie(e,n){const t=U(e);if(!t){o("Invalid subscription domain","error");return}ae(t,n)}async function ae(e,n){const t=document.getElementById(n).value.trim();if(!t){o("Feed URL cannot be empty","error");return}try{const s=await fetch(`/api/rss-subscriptions/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({feed_url:t})}),i=await s.json();if(!s.ok){o(i.error||"Failed to update subscription","error");return}o(`Subscription updated: ${e}`,"success"),await k()}catch{o("Failed to update subscription","error")}}function ce(e,n){const t=U(e);if(!t){o("Invalid subscription domain","error");return}le(t,n)}async function le(e,n){const t=n?`Remove ${e} and delete all related articles from the feed?`:`Remove ${e} subscription?`;if(confirm(t))try{const s=`/api/rss-subscriptions/${encodeURIComponent(e)}?delete_articles=${n?"true":"false"}`,i=await fetch(s,{method:"DELETE"}),a=await i.json();if(!i.ok){o(a.error||"Failed to remove subscription","error");return}n?(o(`Removed ${e} and deleted ${a.deleted_articles||0} articles`,"success"),await h()):o(`Removed ${e} subscription`,"success"),await k()}catch{o("Failed to remove subscription","error")}}async function de(){if(confirm("Archive all current articles? This will clear the main view."))try{const n=await(await fetch("/api/archive-all",{method:"POST"})).json();n.success?(o(`Archived ${n.archived_count} articles`,"success"),await h()):o("Failed to archive","error")}catch{o("Failed to archive","error")}}async function ue(e){if(!["pending","shortlisted","rejected"].includes(e)){o("Invalid status","error");return}const n=e.charAt(0).toUpperCase()+e.slice(1);if(!confirm(`Archive all ${n.toLowerCase()} articles?`))return;const t=document.getElementById("queue-list");t&&(y[d]=t.scrollTop);try{const s=await fetch("/api/archive-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:e})}),i=await s.json();if(!s.ok){o(i.error||"Failed to archive","error");return}o(`Archived ${i.archived_count} ${e} article(s)`,"success"),await h()}catch{o("Failed to archive","error")}}async function me(){document.getElementById("archives-modal").classList.add("active"),await pe(),await K()}function J(){document.getElementById("archives-modal").classList.remove("active")}async function pe(){try{const n=await(await fetch("/api/archived/weeks")).json(),t=document.getElementById("archive-week-filter");t.innerHTML='<option value="">All weeks</option>'+n.weeks.map(s=>`<option value="${s.week}">${s.week} (${s.shortlisted} shortlisted, ${s.rejected} rejected)</option>`).join("")}catch(e){console.error("Failed to load archive weeks:",e)}}async function K(){const e=document.getElementById("archive-week-filter").value,n=document.getElementById("archived-list"),t=document.getElementById("archive-count");try{const s=e?`/api/archived?week=${e}`:"/api/archived",a=await(await fetch(s)).json();if(t.textContent=`${a.count} archived articles`,a.articles.length===0){n.innerHTML='<div class="empty-state"><p>No archived articles</p></div>';return}n.innerHTML=a.articles.map(r=>`
                    <div class="archived-item">
                        <div class="archived-item-info">
                            <div class="archived-item-title">
                                <a href="${m(r.url)}" target="_blank">${m(r.title)}</a>
                            </div>
                            <div class="archived-item-meta">
                                <span class="status-badge status-${r.status}">${r.status}</span>
                                <span>${r.source}</span>
                                <span>Week: ${r.week}</span>
                                <span>Archived: ${new Date(r.archived_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="archived-item-actions">
                            <button class="btn btn-primary" onclick="unarchiveArticle('${r.id}')" style="padding: 4px 10px; font-size: 0.75rem;">Unarchive</button>
                        </div>
                    </div>
                `).join("")}catch{n.innerHTML='<div class="empty-state"><p>Failed to load archives</p></div>'}}async function fe(e){try{(await(await fetch(`/api/articles/${e}/unarchive`,{method:"POST"})).json()).success?(o("Article unarchived","success"),await K(),await h()):o("Failed to unarchive","error")}catch{o("Failed to unarchive","error")}}function he(e){if(!O.includes(e))return;const n=document.getElementById("queue-list");n&&(y[d]=n.scrollTop),d=e,I({preserveScroll:!0,animate:!1}),z()}function T(){return f[d]||[]}function I(e={}){const n=e.preserveScroll!==!1,t=e.animate!==!1;O.forEach(r=>{const c=document.getElementById(`count-${r}`),l=document.getElementById(`queue-filter-${r}`),u=(f[r]||[]).length;c&&(c.textContent=u),l&&l.classList.toggle("active",d===r)});const s=document.getElementById("queue-list"),i=s?s.scrollTop:0,a=T();if(!a.length){s.innerHTML=`<div class="empty-state"><p>No ${d} articles</p></div>`,y[d]=0;return}if(s.innerHTML=a.map((r,c)=>{const l=r.id===p,u=r.summary?r.summary.length>120?r.summary.substring(0,120)+"...":r.summary:"",v=t?`animation-delay: ${Math.min(c*28,280)}ms;`:"animation: none; opacity: 1; transform: translateY(0);";return`
                    <article class="queue-item ${l?"active":""}" data-article-id="${r.id}" tabindex="0" style="${v}" onclick="openReader('${r.id}')">
                        <div class="queue-item-top">
                            <h3 class="queue-item-title">${m(r.title)}</h3>
                            ${r.top_pick?'<span class="queue-pill top-pick">Top Pick</span>':""}
                        </div>
                        <div class="queue-item-meta">
                            <span class="queue-pill source">${m(r.source)}</span>
                            ${r.topic?`<span class="queue-pill topic">${m(r.topic)}</span>`:""}
                        </div>
                        ${u?`<p class="queue-item-summary">${m(u)}</p>`:""}
                        <div class="queue-item-actions">
                            ${ve(r.id,d)}
                        </div>
                    </article>
                `}).join(""),s){const r=y[d]||i||0;s.scrollTop=n?r:0}}function ve(e,n){return n==="pending"?`
                    <button class="btn btn-success" onclick="event.stopPropagation(); curate('${e}', 'shortlisted')">Shortlist</button>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); curate('${e}', 'rejected')">Reject</button>
                    <button class="btn btn-feed-remove" onclick="event.stopPropagation(); removeFeedForArticle('${e}', true)">Remove Feed</button>
                `:n==="shortlisted"?`
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); curate('${e}', 'pending')">Reset</button>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); curate('${e}', 'rejected')">Reject</button>
                    <button class="btn btn-feed-remove" onclick="event.stopPropagation(); removeFeedForArticle('${e}', true)">Remove Feed</button>
                `:`
                <button class="btn btn-secondary" onclick="event.stopPropagation(); curate('${e}', 'pending')">Reset</button>
                <button class="btn btn-success" onclick="event.stopPropagation(); curate('${e}', 'shortlisted')">Shortlist</button>
                <button class="btn btn-feed-remove" onclick="event.stopPropagation(); removeFeedForArticle('${e}', true)">Remove Feed</button>
            `}function z(){const e=T();if(!e.length){ee();return}if(!e.some(t=>t.id===p)){const t=typeof g=="number"?Math.min(g,e.length-1):0;g=null,B(e[t].id,{refreshQueue:!1,animatedSwitch:!0});return}g=null,B(p,{refreshQueue:!1,animatedSwitch:!1})}async function b(e,n){try{const s=T().findIndex(r=>r.id===e);s>=0&&(g=s);const i=document.getElementById("queue-list");i&&(y[d]=i.scrollTop),await ke(e,n),(await fetch(`/api/articles/${e}/curate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:n})})).ok?(await h(),o(`Article ${n}`,"success")):o("Failed to update article","error")}catch{o("Failed to update article","error")}}async function V(e,n){try{(await fetch(`/api/articles/${e}/top-pick`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({top_pick:n})})).ok?(await h(),o(n?"Marked as Top Pick":"Top Pick removed","success")):o("Failed to update Top Pick","error")}catch{o("Failed to update Top Pick","error")}}function C(e){return(e||"").toLowerCase().replace(/^www\./,"")}function N(e){if(!e)return"";try{return C(new URL(e).hostname)}catch{return""}}function ye(e){const n=C(e?.source||""),t=N(e?.url||""),s=[n,t].filter(Boolean);if(!s.length)return"";const i=E.find(a=>{const r=C(a.domain||""),c=N(a.feed_url||"");return s.some(l=>l===r||l===c)});return i?i.domain:""}async function W(e,n=!0){const t=Z(e);if(!t){o("Article not found","error");return}E.length||await k();const s=ye(t);if(!s){o("Could not map article to an RSS subscription","error");return}const i=n?`Remove feed "${s}" and delete all related articles?`:`Remove feed "${s}" subscription?`;if(!confirm(i))return;const r=T().findIndex(l=>l.id===e);r>=0&&(g=r);const c=document.getElementById("queue-list");c&&(y[d]=c.scrollTop);try{const l=`/api/rss-subscriptions/${encodeURIComponent(s)}?delete_articles=${n?"true":"false"}`,u=await fetch(l,{method:"DELETE"}),v=await u.json();if(!u.ok){o(v.error||"Failed to remove feed subscription","error");return}o(n?`Removed ${s} and deleted ${v.deleted_articles||0} related articles`:`Removed ${s} subscription`,"success"),await k(),await h()}catch{o("Failed to remove feed subscription","error")}}function ge(e,n){w("saving","Saving notes..."),j[e]&&clearTimeout(j[e]),A&&clearTimeout(A),j[e]=setTimeout(async()=>{try{if(!(await fetch(`/api/articles/${e}/curate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:n})})).ok)throw new Error("Failed to save notes");w("saved","Saved"),A=setTimeout(()=>{w("idle","Notes auto-save as you type.")},1400)}catch(t){console.error("Failed to save notes:",t),w("error","Save failed. Retrying on next edit.")}},500)}async function we(){if(f.shortlisted.length===0){o("No shortlisted articles to include","error");return}o("Generating newsletter...","success");try{const t=await(await fetch("/api/generate-newsletter",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).json();t.success?(o(`Newsletter generated with ${t.article_count} articles`,"success"),G(t.newsletter_id)):o(t.error||"Failed to generate newsletter","error")}catch{o("Failed to generate newsletter","error")}}async function G(e=null){const n=document.getElementById("newsletter-modal"),t=document.getElementById("newsletter-list"),s=document.getElementById("newsletter-content");n.classList.add("active"),t.innerHTML='<h3>Past Newsletters</h3><div class="loading">Loading...</div>';try{const a=await(await fetch("/api/newsletters")).json();if(a.newsletters.length===0){t.innerHTML='<h3>Past Newsletters</h3><div class="empty-state"><p>No newsletters generated yet.</p></div>',s.innerHTML='<div class="empty-state"><p>Shortlist some articles and click "Generate Newsletter".</p></div>';return}t.innerHTML="<h3>Past Newsletters</h3>"+a.newsletters.map(c=>`
                        <div class="newsletter-item" data-id="${c.id}"
                             onclick="loadNewsletterContent('${c.id}')">
                            <span>${c.week}</span>
                            <span style="font-size: 0.8rem; opacity: 0.7;">${new Date(c.generated_at).toLocaleString()}</span>
                        </div>
                    `).join("");const r=e||a.newsletters[0].id;await X(r)}catch{t.innerHTML='<h3>Past Newsletters</h3><div class="empty-state"><p>Failed to load newsletters.</p></div>'}}async function X(e){const n=document.getElementById("newsletter-content");n.innerHTML='<div class="loading">Loading...</div>',document.querySelectorAll(".newsletter-item").forEach(t=>{t.classList.toggle("active",t.dataset.id===e)});try{const t=await fetch(`/api/newsletter/${e}`);if(t.ok){const s=await t.json();n.innerHTML=Be(s.content)}else n.innerHTML='<div class="empty-state"><p>Newsletter not found.</p></div>'}catch{n.innerHTML='<div class="empty-state"><p>Failed to load newsletter.</p></div>'}}function Y(){document.getElementById("newsletter-modal").classList.remove("active")}function be(){document.getElementById("add-article-modal").classList.add("active"),document.getElementById("article-url").focus()}function Z(e){return[...f.pending,...f.shortlisted,...f.rejected].find(t=>t.id===e)}function B(e,n={}){const t=Z(e);if(!t){o("Article not found","error");return}const s=n.refreshQueue!==!1,i=n.animatedSwitch!==!1;if(p=e,s&&I({preserveScroll:!0,animate:!1}),i){const S=document.querySelector(".reader-panel");S&&(S.classList.remove("reader-switching"),S.offsetWidth,S.classList.add("reader-switching"),setTimeout(()=>S.classList.remove("reader-switching"),220))}const a=document.getElementById("reader-title"),r=document.getElementById("reader-meta"),c=document.getElementById("reader-open-link"),l=document.getElementById("reader-iframe"),u=document.getElementById("reader-notes-input"),v=document.getElementById("reader-reset"),te=document.getElementById("reader-remove-feed"),L=document.getElementById("reader-top-pick"),$=t.status||"pending";a.textContent=t.title||"Article",r.innerHTML=`
                <span>${m(t.source||"")}</span>
                ${t.topic?`<span>Topic: ${m(t.topic)}</span>`:""}
                <span>Status: ${m($)}</span>
            `,c.href=t.url,l.src=t.url,u.value=t.user_notes||"",u.oninput=()=>ge(e,u.value),w("idle","Notes auto-save as you type.");const _=document.getElementById("reader-shortlist"),M=document.getElementById("reader-reject");_.style.display=$==="shortlisted"?"none":"inline-flex",M.style.display=$==="rejected"?"none":"inline-flex",v.style.display=$==="pending"?"none":"inline-flex",L.style.display=$==="shortlisted"?"inline-flex":"none",L.classList.toggle("active",!!t.top_pick),_.onclick=async()=>{await b(e,"shortlisted")},M.onclick=async()=>{await b(e,"rejected")},v.onclick=async()=>{await b(e,"pending")},te.onclick=async()=>{await W(e,!0)},L.onclick=async()=>{await V(e,!t.top_pick)}}function ee(){document.getElementById("reader-title").textContent="Select an article",document.getElementById("reader-meta").innerHTML="",document.getElementById("reader-iframe").src="about:blank",document.getElementById("reader-notes-input").value="",document.getElementById("reader-open-link").removeAttribute("href"),w("idle","Notes auto-save as you type."),p=null,I({preserveScroll:!0,animate:!1})}function R(){document.getElementById("add-article-modal").classList.remove("active"),document.getElementById("add-article-form").reset()}async function Ee(){const e=document.getElementById("article-url").value.trim();if(!e){o("Please enter a URL first","error");return}o("Fetching article metadata...","success");try{const t=await(await fetch("/api/fetch-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})})).json();t.success?(t.title&&(document.getElementById("article-title").value=t.title),t.summary&&(document.getElementById("article-summary").value=t.summary),o("Metadata fetched!","success")):o("Could not fetch metadata: "+(t.error||"Unknown error"),"error")}catch{o("Failed to fetch metadata","error")}}async function $e(e){e.preventDefault();const n=document.getElementById("article-url").value.trim(),t=document.getElementById("article-title").value.trim();if(!n||!t){o("URL and title are required","error");return}try{const i=await(await fetch("/api/articles/manual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,title:t,summary:document.getElementById("article-summary").value.trim(),topic:document.getElementById("article-topic").value,notes:document.getElementById("article-notes").value.trim(),auto_shortlist:document.getElementById("article-shortlist").checked})})).json();i.success?(o("Article added successfully!","success"),R(),await h()):o(i.error||"Failed to add article","error")}catch{o("Failed to add article","error")}}function Se(e){if(D!=="articles"||e.metaKey||e.ctrlKey||e.altKey)return;const n=e.target;if(n&&["INPUT","TEXTAREA","SELECT"].includes(n.tagName))return;const t=T();if(!t.length)return;const s=t.findIndex(a=>a.id===p),i=s>=0?s:0;if(e.key==="j"||e.key==="J"){e.preventDefault();const a=Math.min(t.length-1,i+1);B(t[a].id);return}if(e.key==="k"||e.key==="K"){e.preventDefault();const a=Math.max(0,i-1);B(t[a].id);return}if(p){if(e.key==="s"||e.key==="S"){e.preventDefault(),b(p,"shortlisted");return}if(e.key==="r"||e.key==="R"){e.preventDefault(),b(p,"rejected");return}(e.key==="n"||e.key==="N")&&(e.preventDefault(),document.getElementById("reader-notes-input").focus())}}function w(e,n){const t=document.getElementById("notes-save-status");t&&(t.className=`notes-save-status ${e}`,t.textContent=n)}async function ke(e,n){const t=document.querySelector(`.queue-item[data-article-id="${e}"]`);t&&(t.classList.remove("status-shift-shortlisted","status-shift-rejected","status-shift-pending"),t.classList.add(`status-shift-${n}`),await new Promise(s=>setTimeout(s,170)))}function Be(e){return e?e.replace(/^### \[(.*?)\]\((.*?)\)/gm,'<h3><a href="$2" target="_blank">$1</a></h3>').replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^> (.*$)/gm,"<blockquote>$1</blockquote>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/^---$/gm,"<hr>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>"):""}function m(e){const n=document.createElement("div");return n.textContent=e||"",n.innerHTML}function o(e,n="success"){const t=document.querySelector(".toast");t&&t.remove();const s=document.createElement("div");s.className=`toast ${n}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>s.remove(),3e3)}const P=document.getElementById("newsletter-modal");P&&P.addEventListener("click",e=>{e.target.classList.contains("modal")&&Y()});const q=document.getElementById("add-article-modal");q&&q.addEventListener("click",e=>{e.target.classList.contains("modal")&&R()});const H=document.getElementById("archives-modal");H&&H.addEventListener("click",e=>{e.target.classList.contains("modal")&&J()});document.addEventListener("keydown",Se);const F=document.getElementById("queue-list");F&&F.addEventListener("scroll",()=>{y[d]=F.scrollTop});window.archiveAll=de;window.archiveStatus=ue;window.closeAddArticle=R;window.closeArchives=J;window.closeModal=Y;window.closeReader=ee;window.curate=b;window.fetchMetadata=Ee;window.generateNewsletter=we;window.loadNewsletterContent=X;window.openAddArticle=be;window.openArchives=me;window.onSubscriptionsSortChange=re;window.openReader=B;window.removeFeedForArticle=W;window.removeSubscriptionByEncoded=ce;window.saveSubscriptionByEncoded=ie;window.setQueueStatus=he;window.submitArticle=$e;window.switchView=oe;window.toggleTopPick=V;window.unarchiveArticle=fe;window.viewNewsletter=G;ne();
